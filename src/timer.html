<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Timer</title>
        <script>
            /*
             * TODO:
             * - service worker for offline
             */

            function notify(title) {
                // https://developer.mozilla.org/ru/docs/Web/API/notification
                if (Notification.permission === 'granted') {
                    new Notification(title);
                } else if (Notification.permission !== 'denied') {
                    Notification.requestPermission(function (permission) {
                        if (permission === 'granted') {
                            Notification(title);
                        }
                    })
                }
            }

            function random(min, max) {
                const num = Math.floor(Math.random() * (max - min)) + min
                return num
            }

            function timer(finish, fn, check) {
                let seconds = 0
                const SECOND = 1000

                let timerID = setTimeout(function run() {

                    seconds++

                    check(seconds, timerID)

                    if (seconds === finish) {
                        fn()
                        return
                    }

                    itmerID = setTimeout(run, SECOND)
                }, SECOND)

                return [seconds, timerID]
            }

            function render(data) {
                const results = document.getElementById('results')
                const fragment = document.createDocumentFragment()
                data.split('\n').forEach(line => fragment.append(document.createTextNode(line + '\n')))
                results.replaceChildren(fragment)
            }

            function main() {
                const start = document.getElementById('start')

                start.addEventListener('click', function() {

                    start.disabled = true

                    const time = 25 * 60
                    const count = 0

                    timer(
                        time,
                        function() {
                            start.disabled = false
                            const timeEnd = Date.now()
                            const timeStart = timeEnd - time
                            const today = new Date().toISOString().slice(0, 10);
                            let data = window.localStorage.getItem('timer') || ''
                            data = `${today} ${timeStart} ${timeEnd}\n` + data
                            window.localStorage.setItem('timer', data)
                            start.innerText = 'Старт 25'
                            notify('5 минут на отдых')
                            render(data)
                        },
                        function(s) {
                            if (!((time - s + 1) % 60)) { // Каждые 60 секунд
                                const countdown = Math.floor((time - s) / 60)
                                start.innerText =  'Осталось ' + countdown
                            }
                        }
                    )
                })
            }

            document.addEventListener('DOMContentLoaded', main)
        </script>
    </head>
    <body>
        <button id="start">Старт 25</button>
        <pre id="results"></pre>
    </body>
</html>
