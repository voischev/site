<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Timer</title>
        <script>
            /*
            TODO:
            - service worker for offline
            - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤ LS –Ω–∞ 1 –≥–æ–¥
            - –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –Ω–∞ canvas
            - –Ω–µ–¥–µ–ª—å–Ω—ã–π —Ç–∞—Ä–≥–µ—Ç
            */

            function notify(title) {
                // https://developer.mozilla.org/ru/docs/Web/API/notification
                if (Notification.permission === 'granted') {
                    new Notification(title);
                } else if (Notification.permission !== 'denied') {
                    Notification.requestPermission(function (permission) {
                        if (permission === 'granted') {
                            Notification(title);
                        }
                    })
                }
            }

            function random(min, max) {
                const num = Math.floor(Math.random() * (max - min)) + min
                return num
            }

            function timer(finish, fn, check) {
                let seconds = 0
                const SECOND = 1000

                let timerID = setTimeout(function run() {

                    seconds++

                    check(seconds, timerID)

                    if (seconds === finish) {
                        fn()
                        return
                    }

                    itmerID = setTimeout(run, SECOND)
                }, SECOND)

                return [seconds, timerID]
            }

            function render(data) {
                const results = document.getElementById('results')
                const fragment = document.createDocumentFragment()
                const days = {}
                const week = ['–≤—Å', '–ø–Ω', '–≤—Ç', '—Å—Ä', '—á—Ç', '–ø—Ç', '—Å–±']

                data.split('\n').forEach(line => {
                    if (!line) {
                        return
                    }
                    const milliseconds = Number(line.split(' ')[0])
                    const date = new Date(milliseconds)
                    const today = date.toISOString().slice(0, 10) + ' ' + week[date.getDay()];
                    days[today] = days[today] ? (days[today] + 1) : 1
                })

                for (let day in days) {
                    fragment.append(document.createTextNode(`${day} ${days[day]} ${new Array(days[day] + 1).join('üçÖ')}\n`))
                }

                results.replaceChildren(fragment)
            }

            function getData() {
                return window.localStorage.getItem('timer')
            }

            class DataBase {
                constructor() {
                    this.name = 'timer'
                }
                getItem() {
                    return window.localStorage.getItem(this.name)
                }
                setItem(data) {
                    window.localStorage.setItem(this.name, data)
                }
            }

            function main() {
                const db = new DataBase()
                const data = db.getItem()

                if (data) {
                    render(data)
                }

                const start = document.getElementById('start')
                start.addEventListener('click', function() {

                    start.disabled = true

                    const time = 25 * 60
                    const count = 0

                    timer(
                        time,
                        function() {
                            start.disabled = false
                            const timeEnd = Date.now()
                            const timeStart = timeEnd - time
                            let data = db.getItem() || ''
                            data = `${timeStart} ${timeEnd}\n` + data
                            db.setItem(data)
                            start.innerText = '–°—Ç–∞—Ä—Ç 25'
                            notify('5 –º–∏–Ω—É—Ç –Ω–∞ –æ—Ç–¥—ã—Ö')
                            render(data)
                        },
                        function(s) {
                            if (!((time - s + 1) % 60)) { // –ö–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
                                const countdown = Math.floor((time - s) / 60)
                                start.innerText =  '–û—Å—Ç–∞–ª–æ—Å—å ' + countdown
                            }
                        }
                    )
                })
            }

            document.addEventListener('DOMContentLoaded', main)
        </script>
    </head>
    <body>
        <button id="start">–°—Ç–∞—Ä—Ç 25</button>
        <pre id="results"></pre>
    </body>
</html>
