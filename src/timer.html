<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Timer</title>
        <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAA3ZJREFUWEfFl19I01EUx7/3t82tOVOnWS4wp4UUqS9KBbUsEDV8NzAsdBRRQlJRFNJLT1EUaP9AfSgNpVcp7a8uQSmR1EoorFjlZKbTTc3Z3I3726Zzbvv9Nhfex9/v3HM+55x7zj2XQOSi5fkacJJiADpQmgkgBUCce/skACMIGQRggHOhlTQ8HxGjmggJUX3RblDnGQAlQrI+/1tAuFuk7mlPsH0BAWhenhTp8psATodo2Fe8FsP2KtLR4fCnxy8A1RdmgdIHALLFGJ8mC7in+oFzttRA4v0gpIzUtQ34CqwAoOWFe0FoK4BYMcbHuHmkaQxwgOLPz/xgW6ZASTFpaOvyFloG4PbcEMz4S8U4XssncHVqG6+nS27BvqS30DrW4atJx3+bI048UYyhU25BtTUNic4oj80pEKLzjsQigDvnvcHCfip+CHdURl7ZWVsqrk9m4JHShNKEAey3q9FhzsWgzIZDG/owKrGjfmInymY0vlHpx7A9x3MmlgAqCmqEDtx7mQ25m7r5cLN13qZFnFOKy7FfcHRGg5z5WFTGDyFlQYFn5hxkOKIDpaSW1LdXsp88gLvUusXkvC/Kil0bexYhfPeUzibznsspF1wd4fawEnUBVBQ0h1LnH2XTOJj0DmZufpmRh+OZODK7IuSBQFpIffthwnc4wv0S4723jJVzICW5E1PcUnlXW9NxwapFNJWIU0edmwnVFx4HpffF7XBJsVOuV39Ak9K0YpuCcrhkTUOVLRUqIRBCTjCARlBaKhbgs3QG+Um9MErmcNuyHawy2Mr8G8NXgGcxkCvWrbho1QZWTUgToRUF/QCyxAAwj48lDELtlOGFOQfrqRSpyQYwY6wJNSpHcFL9CawzMu/vTuwQOhMDDMDidasF5HisHEWNyoiiuURU2rbwBt7ILdD5NCFmvEVpQslssnAKgEkG4CrqMJanCR2wq/HKnBuGBmBVANdivuHG+u9o/p0NBhHOEp0Cf8pZuKNAECXUdAKT8SkQfQjD8VBgz0DIZRhRCL4Mw2hEEYPgG1GYrTgiEKwVM0WhXkYRMQ64LiMewDX5irqOI2Qc8L6O3VEQHEgiZhxYPpDwAK4xPOhIFiEA/yOZKxX8OB50KF0lROCh1KM41LE8BCDhsXwRIsSHiQgI8Q+TRYi1fJp5e7Rmj1PfsP6v5/k/4Rp65G+63UoAAAAASUVORK5CYII=">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script>
            /*
            TODO:
            - service worker for offline
            - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤ LS –Ω–∞ 1 –≥–æ–¥
            - –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –Ω–∞ canvas
            - –Ω–µ–¥–µ–ª—å–Ω—ã–π —Ç–∞—Ä–≥–µ—Ç
            */

            function notify(title) {
                // https://developer.mozilla.org/ru/docs/Web/API/notification
                const show = function() {
                    const n = new Notification(title, { vibrate: [200, 100, 200] })
                    document.addEventListener('visibilitychange', function handler() {
                        if (document.visibilityState === 'visible') {
                            n.close()
                            document.removeEventListener('visibilitychange', handler)
                        }
                    })
                }
                if (Notification.permission === 'granted') show()
                else if (Notification.permission !== 'denied') {
                    Notification.requestPermission(function(permission) {
                        if (permission === 'granted') show()
                    })
                }
            }

            function random(min, max) {
                const num = Math.floor(Math.random() * (max - min)) + min
                return num
            }

            function render(data) {
                const results = document.getElementById('results')
                const fragment = document.createDocumentFragment()
                const days = {}
                const week = ['–≤—Å', '–ø–Ω', '–≤—Ç', '—Å—Ä', '—á—Ç', '–ø—Ç', '—Å–±']

                data.split('\n').forEach(line => {
                    if (!line) {
                        return
                    }
                    const milliseconds = Number(line.split(' ')[0])
                    const date = new Date(milliseconds)
                    const today = date.toISOString().slice(0, 10) + ' ' + week[date.getDay()];
                    days[today] = days[today] ? (days[today] + 1) : 1
                })

                for (let day in days) {
                    fragment.append(document.createTextNode(`${day} ${days[day]} ${new Array(days[day] + 1).join('üçÖ')}\n`))
                }

                results.replaceChildren(fragment)
            }

            function display(count) {

                const canvas = document.createElement('canvas')
                canvas.height = canvas.width = 32

                const ctx = canvas.getContext('2d')
                ctx.fillStyle = '#ff6347'
                ctx.beginPath()
                ctx.arc(16, 16, 16, 0, 2 * Math.PI)
                ctx.fill()
                ctx.font = '32px cursive'
                ctx.textBaseline = 'center'
                ctx.textAlign = 'center'
                ctx.fillStyle = count ? '#fff' : '#008000'
                ctx.fillText(count || '*', 16, 26, 32)
                document.title = count || 'Timer'

                const o = document.querySelectorAll('link[rel="icon"]')
                for (let i = 0; i < o.length; i++) {
                    o[i].parentNode.removeChild(o[i])
                }

                const link = document.createElement('link')
                link.setAttribute('rel', 'icon')
                link.setAttribute('href', canvas.toDataURL())
                document.querySelector('head').appendChild(link)
            }

            class DataBase {
                constructor() {
                    this.name = 'timer'
                }
                getItem() {
                    return window.localStorage.getItem(this.name)
                }
                setItem(data) {
                    window.localStorage.setItem(this.name, data)
                }
            }

            function main() {
                const timerWorker = new Worker('timer.js');

                const db = new DataBase()
                const data = db.getItem()

                if (data) {
                    render(data)
                }

                const start = document.getElementById('start')
                start.onclick = function() {
                    start.disabled = true

                    const minutes = 25

                    timerWorker.postMessage(minutes)
                    timerWorker.onmessage = function(event) {
                        const minutes = event.data

                        if (minutes) {
                            display(minutes)
                            start.innerText = minutes
                            return
                        }

                        start.disabled = false
                        start.innerText = '–¢–∞–π–º–µ—Ä'
                        const timeEnd = Date.now()
                        const timeStart = timeEnd - minutes * 60
                        let data = db.getItem() || ''
                        data = `${timeStart} ${timeEnd}\n` + data
                        db.setItem(data)
                        notify('–ó–∞–∫–æ–Ω—á–∏–ª–∞—Å—å –ø–æ–º–∏–¥–æ—Ä–∫–∞')
                        render(data)
                        display(minutes)
                    }
                }
            }

            document.addEventListener('DOMContentLoaded', main)
        </script>
    </head>
    <body>
        <button id="start">–¢–∞–π–º–µ—Ä</button>
        <pre id="results"></pre>
    </body>
</html>
