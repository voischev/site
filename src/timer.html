<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Timer</title>
        <link rel="icon" href='data:image/svg+xml,%3Csvg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"%3E%3Ccircle cx="16" cy="16" r="16" fill="%23ff6347" /%3E%3Ctext x="16" y="26" fill="%23008000" text-anchor="middle" style="font-size:32px;font-family:cursive"%3E*%3C/text%3E%3C/svg%3E'>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script>
            /*
            TODO:
            - service worker for offline
            - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤ LS –Ω–∞ 1 –≥–æ–¥
            - –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –Ω–∞ canvas
            - –Ω–µ–¥–µ–ª—å–Ω—ã–π —Ç–∞—Ä–≥–µ—Ç
            */

            function notify(title) {
                // https://developer.mozilla.org/ru/docs/Web/API/notification
                const show = function() {
                    const n = new Notification(title, { vibrate: [200, 100, 200] })
                    document.addEventListener('visibilitychange', function handler() {
                        if (document.visibilityState === 'visible') {
                            n.close()
                            document.removeEventListener('visibilitychange', handler)
                        }
                    })
                }
                if (Notification.permission === 'granted') show()
                else if (Notification.permission !== 'denied') {
                    Notification.requestPermission(function(permission) {
                        if (permission === 'granted') show()
                    })
                }
            }

            function random(min, max) {
                const num = Math.floor(Math.random() * (max - min)) + min
                return num
            }

            function render(data) {
                const results = document.getElementById('results')
                const fragment = document.createDocumentFragment()
                const days = {}
                const week = ['–≤—Å', '–ø–Ω', '–≤—Ç', '—Å—Ä', '—á—Ç', '–ø—Ç', '—Å–±']

                data.split('\n').forEach(line => {
                    if (!line) {
                        return
                    }
                    const milliseconds = Number(line.split(' ')[0])
                    const date = new Date(milliseconds)
                    const today = date.toISOString().slice(0, 10) + ' ' + week[date.getDay()];
                    days[today] = days[today] ? (days[today] + 1) : 1
                })

                for (let day in days) {
                    fragment.append(document.createTextNode(`${day} ${days[day]} ${new Array(days[day] + 1).join('üçÖ')}\n`))
                }

                results.replaceChildren(fragment)
            }

            function display(count) {

                const canvas = document.createElement('canvas')
                canvas.height = canvas.width = 32

                document.title = count || 'Timer'

                const o = document.querySelectorAll('link[rel="icon"]')
                for (let i = 0; i < o.length; i++) {
                    o[i].parentNode.removeChild(o[i])
                }

                const link = document.createElement('link')
                link.setAttribute('rel', 'icon')
                link.setAttribute('href', `data:image/svg+xml,%3Csvg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"%3E%3Ccircle cx="16" cy="16" r="16" fill="%23ff6347" /%3E%3Ctext x="16" y="26" fill="${count ? '%23fff' : '%23008000'}" text-anchor="middle" style="font-size:32px;font-family:cursive"%3E${count || '*'}%3C/text%3E%3C/svg%3E`)
                document.querySelector('head').appendChild(link)
            }

            class DataBase {
                constructor() {
                    this.name = 'timer'
                }
                getItem() {
                    return window.localStorage.getItem(this.name)
                }
                setItem(data) {
                    window.localStorage.setItem(this.name, data)
                }
            }

            function main() {
                const timerWorker = new Worker('timer.js');

                const db = new DataBase()
                const data = db.getItem()

                if (data) {
                    render(data)
                }

                const start = document.getElementById('start')
                start.onclick = function() {
                    start.disabled = true

                    const minutes = 25

                    timerWorker.postMessage(minutes)
                    timerWorker.onmessage = function(event) {
                        const minutes = event.data

                        if (minutes) {
                            display(minutes)
                            start.innerText = minutes
                            return
                        }

                        start.disabled = false
                        start.innerText = '–¢–∞–π–º–µ—Ä'
                        const timeEnd = Date.now()
                        const timeStart = timeEnd - minutes * 60
                        let data = db.getItem() || ''
                        data = `${timeStart} ${timeEnd}\n` + data
                        db.setItem(data)
                        notify('–ó–∞–∫–æ–Ω—á–∏–ª–∞—Å—å –ø–æ–º–∏–¥–æ—Ä–∫–∞')
                        render(data)
                        display(minutes)
                    }
                }
            }

            document.addEventListener('DOMContentLoaded', main)
        </script>
    </head>
    <body>
        <button id="start">–¢–∞–π–º–µ—Ä</button>
        <pre id="results"></pre>
    </body>
</html>
